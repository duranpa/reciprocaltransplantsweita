---
title: "Plant fitness"
author: ""
date: "21st December 2021"
output:
  bookdown::pdf_book:
    toc: no
    keep_tex: no
    number_sections: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE, warning = FALSE, message = FALSE,
  fig.width=16.9/2.54, fig.height  = 20/2.54,
  cache = FALSE, cache.lazy = FALSE)

library(tidyverse)
library(broom)
library(lmerTest)
library(ggpubr)
library(cowplot)
library(gridGraphics)
```

```{r import-data}
# source('plant_fitness/utils.R')

gnoto <- read_csv(
  "plant_fitness/gnotobiotic_expt_fitness_data.csv",
  col_types = 'ffffffffdi'
)

field <- read_csv(
  "plant_fitness/field_expt_fitness_data.csv", col_types = 'ffffffi'
)

anova <- list()
```

```{r tidy-anova-table-function}

# A function to take the output of the linear models in this document and make
# them into somethin publishable
tidy_anova_table <- function(model){
  model %>% 
    tidy %>% 
    mutate(
      # Change the levels of strata
      # stratum = ifelse(stratum == "chamber", "Chamber", stratum),
      stratum = ifelse(stratum == "block", "Between block", stratum),
      stratum = ifelse(stratum == "Within", "Within block", stratum),
      # Tidy up model term names
      term = gsub(":", " x ", term), # Change : to x in interaction terms
      term = sub("(.)", "\\U\\1", term, perl=TRUE), # Capitalise the first letter
      # term = gsub("x genotype", "x geno.", term),
      # term = gsub("x inoculum", "x inoc.", term),
      R2 = sumsq / sum(sumsq) # Variance explained
    ) %>% 
    rename(
      Stratum = stratum,
      Term = term,
      SS = sumsq,
      MS = meansq,
      F = statistic,
      P = p.value
    )
}
```


# Reinoculated soils

Table \@ref(tab:anova-reinoculated) shows ANOVA results for plant fitness as a function of climate chamber, plant genotype, soil matrix, soil wash, all two-, three- and the four-way interaction, and a random effect accounting for tub nested within chamber. Results are summarised in figure \@ref(fig:PVE-reinoculated).

(ref:anova) Analysis of variance in plant fitness on reinoculated soils. Plant fitness is the block-mean of each genotype, and modelled as a function of climate chamber, plant genotype, recipient soil and microbial inoculum, plus all two-, three- and four-way interactions. Block, nested within climate chamber is included as a random effect.

```{r anova-reinoculated}
# m <- gnoto %>%
#   filter(soil %in% c("Italy", "Sweden"), inoculum %in% c("Italy", "Sweden"), autoclaved == 1) %>%
#   # mutate(r = paste0(chamber, block)) %>%
#   lmer(formula = fruits_per_seedling ~
#          (1 | block) +
#          (1 | chamber) +
#          (1 | genotype) + (1| soil) + (1 | inoculum) +
#          (1 | chamber : genotype) + (1 | chamber : soil) + (1 | chamber : inoculum) +
#          (1 | soil : genotype) + (1 | inoculum : genotype) +
#          (1 | soil : inoculum) +
#          (1 | chamber : soil : genotype) + (1 | chamber : inoculum : genotype) + (1 | inoculum : soil : genotype) +
#          (1 | chamber : soil : inoculum : genotype)
#        )
# VarCorr(m) %>%
#   as.data.frame() %>%
#   select(grp, sdcor) %>%
#   mutate(ve = 100 * (sdcor/ sum(sdcor)))

# 
# hist(resid(m), breaks = 20)
# 
# plot(resid(m), fitted(m))

anova$reinoculated <- gnoto %>%
  filter(soil %in% c("Italy", "Sweden"), inoculum %in% c("Italy", "Sweden"), autoclaved == 1) %>%
  aov(
  formula = 
    fruits_per_seedling ~ chamber * soil * inoculum * genotype + Error(block)
) 



# m.pr <- proj(anova$reinoculated)
# hist(m.pr[['Within']][,'Residuals'])
# hist(m.pr[['block']][,'Residuals'])

anova$reinoculated %>% 
  tidy_anova_table() %>% 
  knitr::kable(
    digits = 3,
    caption = "(ref:anova)")

gnoto %>%
  filter(soil %in% c("Italy", "Sweden"), inoculum %in% c("Italy", "Sweden"), autoclaved == 1) %>%
  mutate(
    fruits_per_seedling = scale(fruits_per_seedling),
    t = paste0(chamber, soil, inoculum),
    t2  = paste0(genotype, block)
    ) %>% 
  lme4::lmer(
    formula = 
      fruits_per_seedling ~ chamber * soil * inoculum * genotype + (1 | t/block)
  ) %>% 
  # summary
  anova
```

(ref:reinoculated) Plant fitness on reinoculated soils. (A) Illustration of the treatments being compared. (B) variance in number of seeds per seedling planted explained in a model including climate chamber, plant genotype, recipient soil, microbial inoculum, and all two-, three- and four-way interactions. Non-significant terms are grouped as 'other terms'. (C) Interaction plots showing plant fitness in each treatment.

```{r treatments-reinoculated, include=FALSE}

# Creates the image of treatment combinations for Fig 2A

reinoculated <- list()

font_size= 0.7
par(mar = c(0,4,0,0))
plot(c(0,9), c(0,-3), type='n', axes=F, xlab = "", ylab="")
# Draw boxes under the plot
rect((1:8)-0.5, -0.5, (1:8)+0.5, -1, col = rep(c("#eb624c", "#1d3d90ff"), each=4))
rect((1:8)-0.5, -1,   (1:8)+0.5, -1.5,  col = rep(c("#eb624c", "#1d3d90ff"), each=2))
rect((1:8)-0.5, -1.5, (1:8)+0.5, -2, col = 0)
rect((1:8)-0.5, -2,   (1:8)+0.5, -2.5, col = c("#eb624c", "#1d3d90ff", "#eb624c", "#1d3d90ff"))
# Insert labels in the boxes
text(1:8, -0.75, rep(c("It", "Sw"), each= 4), cex=font_size)
text(1:8, -1.25, rep(c("It", "Sw"), each=2), cex=font_size)
text(1:8, -1.75, c("Yes", "Yes", "Yes", "Yes"), cex=font_size)
text(1:8, -2.25, c("It", "Sw", "It", "Sw"), cex=font_size)

text(0.4, -0.75, "Chamber",   xpd=NA, adj = c(1,0.5), cex=font_size)
text(0.4, -1.25, "Soil",      xpd=NA, adj = c(1,0.5), cex=font_size)
text(0.4, -1.75, "Sterilised",xpd=NA, adj = c(1,0.5), cex=font_size)
text(0.4, -2.25, "Inoculum",      xpd=NA, adj = c(1,0.5), cex=font_size)

reinoculated$trt<- recordPlot()
```

```{r PVE-reinoculated, fig.cap="(ref:reinoculated)", fig.width=8/2.54, fig.height=21/2.54}


reinoculated$pve <- anova$reinoculated %>%
  tidy_anova_table() %>% 
  group_by(Term = replace(Term, P > 0.05, 'Other terms')) %>%
  summarise(
    Variance = sum(R2)
  ) %>% 
  mutate(Term = fct_relevel(
    Term,
    "Chamber", "Soil", "Genotype", "Chamber x geno.",  "Chamber x soil x geno."
  )) %>%
  arrange(Term) %>%
  ggplot(aes(x = Term, y= 100*Variance)) +
  geom_col() +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    axis.title.x=element_blank()) +
  # scale_x_discrete(
  #   labels =
  #     c('Chamber', 'Genotype', 'Soil','Chamber x\nGenotype', "Chamber x\nGeno. x Soil",  "Other terms")
  # ) +
  labs(
    y = "% var. explained"
  )

pd = position_dodge(0.3)
reinoculated$interaction <- gnoto %>% 
  filter(soil %in% c("Italy", "Sweden"), inoculum %in% c("Italy", "Sweden"), autoclaved == 1) %>% 
  group_by(chamber, soil, inoculum, genotype, autoclaved) %>% 
  summarise(
    mean = mean(fruits_per_seedling),
    sd   = sd(fruits_per_seedling),
    se    = sd / sqrt(n()-1)
  ) %>% 
  mutate(
    # Create some variables with nice titles and entries for plotting
    Soil = ifelse(soil == "Italy", "Italian soil", "Swedish soil"),
    Genotype = ifelse(genotype == "It", "Italian", "Swedish"),
    Inoculum = ifelse(inoculum == "Italy", "Italian", "Swedish")
  ) %>% 
  ggplot(aes(
    x = chamber, y = mean, colour = Genotype,
    shape = Inoculum, group= paste(Genotype, Inoculum),
  )) +
  geom_point(size = 3, position = pd) + 
  geom_line(position = pd) +
  geom_errorbar(
    aes(ymin=mean-se, ymax=mean+se), width=.1, position = pd) +
  facet_grid(~ Soil) +
  theme_bw() + 
  scale_colour_manual(values = c('#eb624c', '#1d3d90ff')) +
  theme(
    legend.position = "bottom",
    legend.title = element_text(size=8),
    legend.text = element_text(size=8)
  )+
  labs(
    x = "Climate chamber",
    y = "Fruits per seedling planted"
  )+
  guides(
    color=guide_legend(
      nrow=2,
      byrow=TRUE,
      override.aes = list(linetype = 0, shape = 15)),
    shape=guide_legend(nrow=2, byrow=TRUE)
    # color = guide_legend()
  )

# cowplot::plot_grid(p0, p1, p2, rel_heights = c(1,2,2), nrow=3)
ggarrange(
  reinoculated$trt,
  reinoculated$pve,
  reinoculated$interaction,
  nrow=3, labels = "AUTO", heights = c(1,2,2))
```

# Field vs climate-chamber experiments

Tables \@ref(tab:anova-native) and \@ref(tab:anova-field) show full ANOVA tables for fitness in the chamber and field experiment. Figure \@ref(fig:field-vs-native) shows variance explained by each term, plus interaction plots.

(ref:native) Analysis of variance in plant fitness on native, non-autoclaved soils. Plant fitness is the block-mean of each genotype, and modelled as a function of climate chamber, plant genotype, and recipient soil, plus all two- and three--way interactions. Block nested within chamber is included as a random effect.

```{r trt-native, include=FALSE}
# Create illustration of treatments for figure S4A

field_native <- list()

font_size= 0.7
par(mar = c(0,4,0,0))
plot(c(0,5), c(0,-3), type='n', axes=F, xlab = "", ylab="")
# Draw boxes under the plot
rect((1:4)-0.5, -0.5, (1:4)+0.5, -1, col = rep(c("#eb624c", "#1d3d90ff"), each=2))
rect((1:4)-0.5, -1,   (1:4)+0.5, -1.5,  col = rep(c("#eb624c", "#1d3d90ff"), each=1))
rect((1:4)-0.5, -1.5, (1:4)+0.5, -2, col = 'gray70')
rect((1:4)-0.5, -2,   (1:4)+0.5, -2.5, col = 0)
# Insert labels in the boxes
text(1:4, -0.75, rep(c("It", "Sw"), each= 2), cex=font_size)
text(1:4, -1.25, rep(c("It", "Sw"), each=1), cex=font_size)
text(1:4, -1.75, "No", cex=font_size)
text(1:4, -2.25, "-", cex=font_size)

text(0.4, -0.75, "Chamber",   xpd=NA, adj = c(1,0.5), cex=font_size)
text(0.4, -1.25, "Soil",      xpd=NA, adj = c(1,0.5), cex=font_size)
text(0.4, -1.75, "Sterilised",xpd=NA, adj = c(1,0.5), cex=font_size)
text(0.4, -2.25, "Inoculum",      xpd=NA, adj = c(1,0.5), cex=font_size)

field_native$trt_native<- recordPlot()
```

```{r trt-field, include = F}
# Create illustration of treatments for figure S4A
font_size= 0.7
par(mar = c(0,4,0,0))
plot(c(0,5), c(0,-3), type='n', axes=F, xlab = "", ylab="")
# Draw boxes under the plot
rect((1:4)-0.5, -0.5, (1:4)+0.5, -1, col = rep(c("#eb624c", "#1d3d90ff"), each=2))
rect((1:4)-0.5, -1,   (1:4)+0.5, -1.5,  col = rep(c("#eb624c", "#1d3d90ff"), each=1))
rect((1:4)-0.5, -1.5, (1:4)+0.5, -2, col = 'gray70')
rect((1:4)-0.5, -2,   (1:4)+0.5, -2.5, col = 0)
# Insert labels in the boxes
text(1:4, -0.75, rep(c("It", "Sw"), each= 2), cex=font_size)
text(1:4, -1.25, rep(c("It", "Sw"), each=1), cex=font_size)
text(1:4, -1.75, "No", cex=font_size)
text(1:4, -2.25, "-", cex=font_size)

text(0.4, -0.75, "Location",   xpd=NA, adj = c(1,0.5), cex=font_size)
text(0.4, -1.25, "Soil",      xpd=NA, adj = c(1,0.5), cex=font_size)
text(0.4, -1.75, "Sterilised",xpd=NA, adj = c(1,0.5), cex=font_size)
text(0.4, -2.25, "Inoculum",      xpd=NA, adj = c(1,0.5), cex=font_size)

field_native$trt_field<- recordPlot()
```


```{r anova-native}
anova$native <- gnoto %>%
  filter(soil %in% c("Italy", "Sweden"), autoclaved == 0) %>% 
  aov(
  formula = 
    fruits_per_seedling ~ chamber * soil * genotype + Error(block)
)


gnoto %>%
  filter(soil %in% c("Italy", "Sweden"), autoclaved == 0) %>% 
  group_by(block, chamber, soil, genotype) %>%
  summarise(
    fruits_per_seedling = mean(fruits_per_seedling),
    .groups = "drop"
  ) %>%
  lme4::lmer(
    formula = fruits_per_seedling ~
      (1|chamber) + (1|soil) + (1|genotype) +
      (1|chamber : soil) + (1|chamber:genotype) + (1|soil:genotype) +
      (1|chamber : soil : genotype) +
      (1 | block)
  ) %>%
  VarCorr() %>%
  as.data.frame() %>%
  select(grp, sdcor) %>%
  mutate(ve = round(100 * (sdcor/ sum(sdcor)), 2))

anova$native %>% 
  tidy_anova_table() %>% 
  knitr::kable(
    digits = 3,
    caption = "(ref:native)"
  )
```


(ref:field) Analysis of variance of plant fitness in the field experiment presented by Thiergart *et al.* (2020). Block-mean fitness of each genotype is modelled as a function of experimental location, plant genotype, and recipient soil, plus all two- and three-way interactions. Block nested within chamber is included as a random effect.

```{r anova-field}
# Calculate block-mean fitness for each genotype
anova$field <- field %>%
  # mutate(block = paste0(location, block)) %>% 
  group_by(block, location, soil, genotype) %>%
  summarise(
    fruits_per_seedling = mean(fruits_per_seedling),
    .groups = "drop"
  ) %>% 
  aov(
    formula = fruits_per_seedling ~ location * soil * genotype + Error(location/block)
    )

field %>%
  # mutate(block = paste0(location, block)) %>%
  group_by(block, location, soil, genotype) %>%
  summarise(
    fruits_per_seedling = mean(fruits_per_seedling),
    .groups = "drop"
  ) %>%
  lme4::lmer(
    formula = fruits_per_seedling ~
      (1|location) + (1|soil) + (1|genotype) +
      (1|location : soil) + (1|location:genotype) + (1|soil:genotype) +
      (1|location : soil : genotype) +
      (1 | block)
  ) %>%
  VarCorr() %>%
  as.data.frame() %>%
  select(grp, sdcor) %>%
  mutate(ve = round(100 * (sdcor/ sum(sdcor)), 2))
  

anova$field %>% 
  tidy_anova_table() %>% 
  mutate(
    Stratum = ifelse(Stratum == "Block", "Between block", Stratum),
    Term = ifelse(Term == 'Site', "Location", Term)
  ) %>% 
  knitr::kable(
    digits = 3,
    caption = "(ref:field)"
  )
```



```{r field-vs-native, fig.cap="Plant fitness on native, non-autoclaved soils in the chamber experiment (A, C, E), and the field experiment presented by Thiergart *et al.* (2020) (B, D, F).  (A, B) Illustration of the treatments being compared. (C, D) variance in number of seeds per seedling planted explained in a model including climate chamber, plant genotype, recipient soil, whether soils were sterilised or not, and all two-, three- and four-way interactions. Non-significant terms are grouped as 'other terms'. (E, F) Interaction plots showing plant fitness in each treatment level showing Italian (red) and Swedish (blue) genotypes grown on Italian (circles) and Swedish (triangles) soils."}

field_native$pve_native <- anova$native %>%
  tidy_anova_table() %>% 
    mutate(Term = fct_relevel(
    Term,
    "Chamber", "Soil", "Genotype", "Chamber x soil", "Chamber x genotype", "Soil x genotype", "Chamber x  genotype x Soil"
  )) %>%
  arrange(Term) %>% 
  ggplot(aes(x = Term, y= 100*R2)) +
  geom_col() +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    axis.title.x=element_blank()
    ) +
  # scale_x_discrete(
  #   labels = c('Chamber', "Genotype", "Soil", 'Chamber x\nGenotype', "Chamber\nx Soil", "Genotype\nx Soil", "Chamber x\nGeno. x Soil")
  # ) +
  labs(
    y = "% var. explained"
  ) +
  lims(
    y = c(0,60)
  )

field_native$pve_field <- anova$field %>%
  tidy_anova_table() %>% 
  mutate(
    Stratum = ifelse(Stratum == "Block", "Between block", Stratum)
  ) %>% 
  mutate(Term = fct_relevel(
    Term,
    "Location", "Soil", "Genotype", "Location x soil", "Location x genotype", "Soil x genotype", "Location x soil x genotype"
  )) %>% 
  ggplot(aes(x = Term, y= 100*R2)) +
  geom_col() +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    axis.title.x=element_blank()) +
  # scale_x_discrete(
  #   labels = c('Location','Soil', "Genotype", 'Location x\nSoil', "Location x\nGenotype", "Soil x\n Genotype", "Location x\nSoil x Geno.", "Residuals")
  # ) +
  labs(
    y = "% var. explained"
  ) +
  lims(
    y = c(0,60)
  )


field_native$int_native <- gnoto %>%
  filter(soil %in% c("Italy", "Sweden"), autoclaved == 0) %>% 
  group_by(chamber, soil, genotype) %>% 
  summarise(
    mean = mean(fruits_per_seedling)
  ) %>% 
  mutate(
    Soil = ifelse(soil == "Italy", "Italian soil", "Swedish soil"),
    Genotype = ifelse(genotype == "It", "Italian", "Swedish")
  ) %>% 
  ggplot(aes(
    x = chamber, y = mean, colour = Genotype,
    shape = Soil, group= paste(Genotype, Soil),
  )) +
  geom_point(size = 3) + 
  geom_line() +
  theme_bw() + 
  scale_colour_manual(values = c('#eb624c', '#1d3d90ff')) +
  labs(
    x = "Climate chamber",
    y = "Fruits per seedling planted"
  ) + 
  theme(legend.position="none")
# guides(
#   colour = guide_legend(override.aes = list(linetype = 0, shape = 15))
# )

field_native$int_field <- field %>% 
  group_by(location, soil, genotype) %>% 
  summarise(
    mean = mean(fruits_per_seedling, na.rm=TRUE)
  ) %>% 
  mutate(
    Soil = ifelse(soil == "It", "Italian soil", "Swedish soil"),
    Genotype = ifelse(genotype == "Italy", "Italian", "Swedish")
  ) %>% 
  ggplot(aes(
    x = location, y = mean, colour = Genotype,
    shape = Soil, group= paste(Genotype, Soil),
  )) +
  geom_point(size = 3) + 
  geom_line() +
  theme_bw() + 
  scale_colour_manual(values = c('#eb624c', '#1d3d90ff')) +
  labs(
    x = "Location",
    y = "Fruits per seedling planted"
  ) +
  theme(legend.position="none")
# guides(
#   colour = guide_legend(override.aes = list(linetype = 0, shape = 15))
# )

ggarrange(
  field_native$trt_native,
  field_native$trt_field,
  field_native$pve_native,
  field_native$pve_field,
  field_native$int_native,
  field_native$int_field,
  ncol=2, nrow=3,
  # common.legend = TRUE, 
  # legend = "none",
  labels = "AUTO",
  heights = c(1,2,2)
) +
  guides(
    colour = guide_legend(override.aes = list(linetype = 0, shape = 15))
  )

```

# Native vs sterilised vs repopulated soils

Table \@ref(tab:anova-nsr) and figure \@ref(fig:nsr-plot) show plant fitness on native (untreated), sterilised, and sterilised-and-reinoculated soils. 

(ref:anova-nsr) Analysis of variance in plant fitness on native (untreated), sterilised, and sterilised-and-reinoculated soils. Plant fitness is the block-mean of each genotype, and modelled as a function of climate chamber, plant genotype, recipient soil, sterilisation-reinoculation treatment, plus all two-, three- and four-way interactions. Block nested within climate chamber is included as random effect.

```{r anova-nsr}
anova$sterilise <- gnoto %>%
  filter(! trt %in% c(4,7, 15, 19)) %>% 
  mutate(
    Treatment = ifelse(autoclaved == 0, "Native", "Sterile"),
    Treatment = ifelse(inoculum != "No", "Reinoculated", Treatment),
    Treatment = fct_relevel(Treatment, "Sterile", after = 2)
  ) %>%  
  aov(
    formula = fruits_per_seedling ~ chamber * soil * Treatment * genotype + Error(chamber/block)
    )

anova$sterilise %>% 
  tidy_anova_table() %>% 
  knitr::kable(
    digits = 3,
    caption = "(ref:anova-nsr)"
  )

```

```{r nsr-treatments, include=FALSE}

sterilised <- list()

font_size= 0.7
par(mar = c(0,4,0,0))
plot(c(0,13), c(1,-4), type='n', axes=F, xlab = "", ylab="")
# Draw boxes under the plot
rect((1:12)-0.5, -0.5, (1:12)+0.5, -1, col = rep(c("#eb624c", "#1d3d90ff"), each=6))
rect((1:12)-0.5, -1,   (1:12)+0.5, -1.5,  col = rep(c("#eb624c", "#1d3d90ff"), each=3))
rect((1:12)-0.5, -1.5, (1:12)+0.5, -2, col = c('gray70',0,0))
rect((1:12)-0.5, -2,   (1:12)+0.5, -2.5, 
     col = c(0, 0, "#eb624c", 0, 0, "#1d3d90ff")
     )
# Insert labels in the boxes
text(1:12, -0.75, rep(c("It", "Sw"), each= 6), cex=font_size)
text(1:12, -1.25, rep(c("It", "Sw"), each=3), cex=font_size)
text(1:12, -1.75, c("No", "Yes", "Yes"), cex=font_size)
text(1:12, -2.25, c("-", "-", "It", "-", "-", "Sw"), cex=font_size)

text(0.4, -0.75, "Chamber",    xpd=NA, adj = c(1,0.5), cex=font_size)
text(0.4, -1.25, "Soil",       xpd=NA, adj = c(1,0.5), cex=font_size)
text(0.4, -1.75, "Sterilised", xpd=NA, adj = c(1,0.5), cex=font_size)
text(0.4, -2.25, "Inoculum",   xpd=NA, adj = c(1,0.5), cex=font_size)

sterilised$trt<- recordPlot()
```

```{r nsr-means}

sterilised$means <- gnoto %>% 
  filter(! trt %in% c(4,7, 15, 19)) %>% 
  group_by(chamber, soil, autoclaved, inoculum, genotype) %>% 
  summarise(
    mean = mean(fruits_per_seedling)
  ) %>% 
  mutate(
    Soil = ifelse(soil == "Italy", "Italian soil", "Swedish soil"),
    Genotype = ifelse(genotype == "It", "Italian", "Swedish"),
    Treatment = ifelse(autoclaved == 0, "Native", "Sterile"),
    Treatment = ifelse(inoculum != "No", "Reinoculated", Treatment)
    # Treatment = fct_relevel(Treatment, "Sterile", after = 2)
  ) %>% 
  rename(Chamber = chamber) %>%
  ggplot(aes(
    x = Treatment, y = mean,
    colour = Genotype, shape = Chamber, group = paste(Genotype, Chamber))) +
  geom_point(size=3) +
  geom_line() +
  facet_grid(~ Soil) +
  theme_bw() +
  scale_colour_manual(values = c('#eb624c', '#1d3d90ff')) +
  labs(
    y = "Fruits per seedling planted"
  )+
  theme(
    legend.position = "none"
)

```


```{r nsr-interactions}

sterilised$interactions <- gnoto %>% 
  filter(! trt %in% c(4,7, 15, 19)) %>% 
  group_by(chamber, soil, autoclaved, inoculum, genotype) %>% 
  summarise(
    mean = mean(fruits_per_seedling)
  ) %>% 
  mutate(
    Soil = ifelse(soil == "Italy", "Italian soil", "Swedish soil"),
    Genotype = ifelse(genotype == "It", "Italian", "Swedish"),
    Treatment = ifelse(autoclaved == 0, "Native", "Sterile"),
    Treatment = ifelse(inoculum != "No", "Reinoculated", Treatment),
    Treatment = fct_relevel(Treatment, "Sterile", after = 2)
  ) %>% 
  rename(Chamber = chamber) %>%

  ggplot(aes(
    x = Chamber, y = mean,
    shape = Soil, colour = Genotype, group = paste(Genotype, Soil) 
    ))+
  geom_point(size=3) +
  geom_line() +
  facet_grid( Soil ~ Treatment) +
theme_bw() +
  scale_colour_manual(values = c('#eb624c', '#1d3d90ff')) +
  labs(
    y = "Fruits per seedling planted"
  )+
  theme(
    legend.position = "top"
) +
  guides(
    colour = guide_legend(
      override.aes = list(linetype = 0, shape = 15)
      )
  )
```

(ref:nsr-plot) Plant fitness on native (untreated), sterilised, and sterilised-and-reinoculated soils. (A) Illustration of the treatments being compared. (B) Changes in genotype-treatment means in each soil treatment. (C) Interaction plots illustrating the changes in the chamber x genotype interaction in each soil treatment.

```{r nsr-plot, fig.width=18/2.54, fig.height=20/2.54, fig.cap= "(ref:nsr-plot)"}
top_row <- ggarrange(sterilised$trt, sterilised$means, labels = c("A", "B"), heights = c(1,2))

ggarrange(top_row, sterilised$interactions, nrow=2, labels = c("-", "C"), heights = c(3,5))
```

