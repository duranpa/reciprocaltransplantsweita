---
title: "Plant fitness"
author: ""
date: "10/29/2021"
output:
  bookdown::pdf_book:
    toc: no
    keep_tex: no
    number_sections: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE, warning = FALSE, message = FALSE,
  fig.width=16.9/2.54, fig.height  = 20/2.54,
  cache = TRUE, cache.lazy = TRUE)

library(tidyverse)
library(lmerTest)
library(ggpubr)
library(cowplot)
library(gridGraphics)
```

```{r import-data}
# source('plant_fitness/utils.R')

gnoto <- read_csv(
  "plant_fitness/gnotobiotic_expt_fitness_data.csv",
  col_types = 'ffffffffdi'
  )

field <- read_csv(
  "plant_fitness/field_expt_fitness_data.csv", col_types = 'ffffffi'
)

anova <- list()
```

# Reinoculated soils

Table \@ref(tab:anova-reinoculated) shows ANOVA results for plant fitness as a function of climate, plant genotype, soil matrix, soil wash, all two-, three- and the four-way interaction, and a random effect accounting for tub. The key points are:

1.  There are significant main effects of climate schedule, genotype and soil type, reflecting increased fitness overall in the Italian climate, of the Italian genotype and on Italian soils.
2.  There is a strong genotype x environment interaction, as we would expect under local adaptation to climate.
3.  There is a significant three-way interaction between climate, plant genotype, and soil matrix. I think this is driven in large part by the universally poor survival in the Swedish climate (see plots below).
4.  The effect of soil wash is not significant on its own, nor in any interactions.
5.  Higher-order terms are not significant.

Results are summarised in figure \@ref(fig:PVE-reinoculated). We would put this in the main text; I have formatted it to fit in a single 8cm column in the printed journal.

(ref:anova) Analysis of variance in plant fitness on reinoculated soils. Plant fitness is the block-mean of each genotype, and modelled as a function of climate chamber, plant genotype, recipient soil and microbial inoculum, plus all two-, three- and four-way interactions. Block is included as a random effect.

```{r anova-reinoculated}
anova$reinoculated <- gnoto %>%
  filter(Soil %in% c("Italy", "Sweden"), Tea %in% c("Italy", "Sweden"), Sterile == 1) %>%
  lmer(formula = fruits_per_seedling ~ Climate * geno * Soil * Tea + plants_per_block + (1 | tub)) %>% 
  anova

knitr::kable(anova$reinoculated, digits = 3,
             caption = "(ref:anova)")


```

(ref:reinoculated) Plant fitness on reinocculated soils. (A) variance in number of seeds per seedling planted explained in a model including climate chamber, plant genotype, recipient soil, microbial inoculum, and all two-, three- and four-way interactions. Non-significant terms are grouped as 'other terms'. (B) Interaction plots showing plant fitness in each treatment.

```{r treatments-reinoculated, include=FALSE}

reinoculated <- list()

font_size= 0.7
par(mar = c(0,4,0,0))
plot(c(0,9), c(0,-3), type='n', axes=F, xlab = "", ylab="")
# Draw boxes under the plot
rect((1:8)-0.5, -0.5, (1:8)+0.5, -1, col = rep(c("#eb624c", "#1d3d90ff"), each=4))
rect((1:8)-0.5, -1,   (1:8)+0.5, -1.5,  col = rep(c("#eb624c", "#1d3d90ff"), each=2))
rect((1:8)-0.5, -1.5, (1:8)+0.5, -2, col = 0)
rect((1:8)-0.5, -2,   (1:8)+0.5, -2.5, col = c("#eb624c", "#1d3d90ff", "#eb624c", "#1d3d90ff"))
# Insert labels in the boxes
text(1:8, -0.75, rep(c("It", "Sw"), each= 4), cex=font_size)
text(1:8, -1.25, rep(c("It", "Sw"), each=4), cex=font_size)
text(1:8, -1.75, c("Yes", "Yes", "Yes", "Yes"), cex=font_size)
text(1:8, -2.25, c("It", "Sw", "It", "Sw"), cex=font_size)

text(0.4, -0.75, "Climate",   xpd=NA, adj = c(1,0.5), cex=font_size)
text(0.4, -1.25, "Soil",      xpd=NA, adj = c(1,0.5), cex=font_size)
text(0.4, -1.75, "Autoclaved",xpd=NA, adj = c(1,0.5), cex=font_size)
text(0.4, -2.25, "Wash",      xpd=NA, adj = c(1,0.5), cex=font_size)

reinoculated$trt<- recordPlot()
```

```{r PVE-reinoculated, fig.cap="(ref:reinoculated)", fig.width=8/2.54, fig.height=18/2.54}
reinoculated$pve <- data.frame(
  term = row.names(anova$reinoculated),
  p    = anova$reinoculated$`Pr(>F)`,
  mse  = anova$reinoculated$`Mean Sq`
) %>% 
  group_by(Term = replace(term, p > 0.05, 'Other terms')) %>% 
  summarise(
    Variance = sum(mse)
  ) %>% 
  mutate(Variance = Variance / sum(Variance)) %>% 
  mutate(Term = fct_reorder(Term, desc(Variance))) %>% 
  ggplot(aes(x = Term, y= Variance*100)) +
  geom_col() +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    axis.title.x=element_blank()) +
  scale_x_discrete(
    labels = c('Chamber','Chamber x\nGenotype','Soil', "Genotype", "Other terms", "Chamber x\nGeno. x Soil")
  ) +
  labs(
    y = "% var. explained"
  )


reinoculated$interaction <- gnoto %>% 
  filter(Soil %in% c("Italy", "Sweden"), Tea %in% c("Italy", "Sweden"), Sterile == 1) %>% 
  group_by(Climate, Soil, Tea, geno, Sterile) %>% 
  summarise(
    mean = mean(fruits_per_seedling)
  ) %>% 
  mutate(
    Soil = ifelse(Soil == "Italy", "Italian soil", "Swedish soil"),
    Genotype = ifelse(geno == "It", "Italian", "Swedish"),
    Inoculum = ifelse( Tea == "Italy", "Italian", "Swedish")
  ) %>% 
  ggplot(aes(
    x = Climate, y = mean, colour = Genotype,
    shape = Inoculum, group= paste(Genotype, Inoculum),
  )) +
  geom_point(size = 3) + 
  geom_line() +
  facet_grid(~ Soil) +
  theme_bw() + 
  scale_colour_manual(values = c('red3', 'blue4')) +
  theme(
    legend.position = "bottom",
    legend.title = element_text(size=6),
    legend.text = element_text(size=6)
  )+
  labs(
    x = "Climate chamber",
    y = "Fruits per seedling planted"
  )+
  guides(
    color=guide_legend(
      nrow=2,
      byrow=TRUE,
      override.aes = list(linetype = 0, shape = 15)),
    shape=guide_legend(nrow=2, byrow=TRUE)
    # color = guide_legend()
  )

# cowplot::plot_grid(p0, p1, p2, rel_heights = c(1,2,2), nrow=3)
ggarrange(
  reinoculated$trt,
  reinoculated$pve,
  reinoculated$interaction,
  nrow=3, labels = "AUTO", heights = c(1,2,3))
```

# Field vs climate-chamber experiments

Tables \@ref(tab:anova-native) and \@ref(tab:anova-field) show full ANOVA tables for fitness in the chamber and field experiment. In both cases there are significant main effects of climate (site or chamber) and genotype, as well as a strong genotype-by-climate interaction.

Figure \@ref(fig:field-vs-native) shows variance explained by each term, plus interaction plots. I did not include a cartoon illustrating the treatments being compared, because this involves data from outside of the experiment.

(ref:native) Analysis of variance in plant fitness on native, non-autoclaved soils. Plant fitness is the block-mean of each genotype, and modelled as a function of climate chamber, plant genotype, and recipient soil, plus all two- and three--way interactions. Block is included as a random effect.

```{r anova-native}
anova$native <- gnoto %>%
  filter(Soil %in% c("Italy", "Sweden"), Sterile == 0) %>% 
  lmer(formula = fruits_per_seedling ~ Climate * geno * Soil + plants_per_block + (1 | tub)) %>% 
  anova() 

anova$native %>% 
  knitr::kable(
    digits = 3,
    caption = "(ref:native)"
  )
```

(ref:field) Analysis of variance of plant fitness on native, non-autoclaved soils in the chamber experiment, and the field experiment presented by Thiergart *et al.* (2020). Fitness of individual plants is modelled as a function of experimental site, plant genotype, and recipient soil, plus all two- and three-way interactions. Block is included as a random effect.

```{r anova-field}
anova$field <- lmer(formula = fruits_per_seedling ~ Site * Genotype * Soil + (1|Tray), data = field) %>% 
  anova

knitr::kable(
  anova$field,
  digits = 3,
  caption = "(ref:field)"
)

```

```{r field-vs-native, fig.cap="Plant fitness on native, non-autoclaved soils in the chamber experiment, and the field experiment presented by Thiergart *et al.* (2020). (A) variance in number of seeds per seedling planted explained in a model including climate chamber, plant genotype, recipient soil, whether soils were sterilised or not, and all two-, three- and four-way interactions. Non-significant terms are grouped as 'other terms'. (B) Interaction plots showing plant fitness in each treatment level."}

field_native <- list()

field_native$pve_native <- data.frame(
  Term = row.names(anova$native),
  p    = anova$native$`Pr(>F)`,
  mse  = anova$native$`Mean Sq`
) %>% 
  mutate(Variance = mse / sum(mse)) %>% 
  mutate(Term = fct_reorder(Term, desc(Variance))) %>%
  filter(Term != "plants_per_block") %>% 
  ggplot(aes(x = Term, y= Variance*100)) +
  geom_col() +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    axis.title.x=element_blank()) +
  scale_x_discrete(
    labels = c('Chamber','Genotype x\nChamber','Genotype', "Chamber x\nSoil", "Soil", "Genotype x\nSoil", "Chamber x\nGeno. x Soil")
  ) +
  labs(
    y = "% var. explained"
  ) +
  lims(
    y = c(0,60)
  )

field_native$pve_field <- data.frame(
  Term = row.names(anova$field),
  p    = anova$field$`Pr(>F)`,
  mse  = anova$field$`Mean Sq`
) %>% 
  mutate(Variance = mse / sum(mse)) %>% 
  mutate(Term = fct_reorder(Term, desc(Variance))) %>%
  ggplot(aes(x = Term, y= Variance*100)) +
  geom_col() +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    axis.title.x=element_blank()) +
  scale_x_discrete(
    labels = c('Genotype x\nSite','Site','Genotype', "Genotype x\nSoil", "Site x Soil", "Soil", "Site x Geno.\nx Soil")
  ) +
  labs(
    y = "% var. explained"
  ) +
  lims(
    y = c(0,60)
  )


field_native$int_native <- gnoto %>% 
  filter(Soil %in% c("Italy", "Sweden"), Sterile == 0) %>% 
  group_by(Climate, Soil, geno) %>% 
  summarise(
    mean = mean(fruits_per_seedling)
  ) %>% 
  mutate(
    Soil = ifelse(Soil == "Italy", "Italian soil", "Swedish soil"),
    Genotype = ifelse(geno == "It", "Italian", "Swedish")
  ) %>% 
  ggplot(aes(
    x = Climate, y = mean, colour = Genotype,
    shape = Soil, group= paste(Genotype, Soil),
  )) +
  geom_point(size = 3) + 
  geom_line() +
  theme_bw() + 
  scale_colour_manual(values = c('red3', 'blue4')) +
  labs(
    x = "Climate chamber",
    y = "Fruits per seedling planted"
  ) + 
  guides(
    colour = guide_legend(override.aes = list(linetype = 0, shape = 15))
  )

field_native$int_field <- field %>% 
  group_by(Site, Soil, Genotype) %>% 
  summarise(
    mean = mean(fruits_per_seedling, na.rm=TRUE)
  ) %>% 
  mutate(
    Soil = ifelse(Soil == "It", "Italian soil", "Swedish soil"),
    Genotype = ifelse(Genotype == "Italy", "Italian", "Swedish")
  ) %>% 
  ggplot(aes(
    x = Site, y = mean, colour = Genotype,
    shape = Soil, group= paste(Genotype, Soil),
  )) +
  geom_point(size = 3) + 
  geom_line() +
  theme_bw() + 
  scale_colour_manual(values = c('red3', 'blue4')) +
  labs(
    x = "Site",
    y = "Fruits per seedling planted"
  ) +
  guides(
    colour = guide_legend(override.aes = list(linetype = 0, shape = 15))
  )

ggpubr::ggarrange(
  field_native$pve_native,
  field_native$pve_field,
  field_native$int_native,
  field_native$int_field,
  ncol=2, nrow=2, common.legend = TRUE, legend = "bottom",
  labels = "AUTO"
) +
  guides(
    colour = guide_legend(override.aes = list(linetype = 0, shape = 15))
  )

```

# Sterilised vs non-sterilised soils

The following table shows the results of a model of plant fitness as a function of climate, plant genotype, soil matrix, and whether soil was sterilised or not, plus all two-, three- and the four-way interaction, and a random effect accounting for tub. The key points are:

1.  There is strong evidence for higher fitness in the Italian climate chamber.
2.  There is strong evidence for a significant effect of sterilisation, with plant fitness being higher on sterilised soils.
3.  Despite the confounding with sterilisation, there is still strong evidence for the genotype x environment interaction expected under local adaptation.
4.  There is moderate evidence for a soil-by-sterilisation interaction, with the effect of sterilisation being weaker on Swedish than on Italian soil.
5.  There is moderate evidence for a three-way interaction between climate chamber, soil type and sterilisation treatment.

(ref:sterilised-anova) Analysis of variance in plant fitness on sterilised vs non-sterilised soils. Plant fitness is the block-mean of each genotype, and modelled as a function of climate chamber, plant genotype, recipient soil and whether soils were sterilised, plus all two-, three- and four-way interactions. Block is included as a random effect.

```{r anova-sterilised}
anova$sterilise <- 
  gnoto %>%
  filter(Soil %in% c("Italy", "Sweden"), Tea == "No") %>% 
  lmer(formula = fruits_per_seedling ~ Climate * geno * Soil * Sterile + plants_per_block + (1 | tub))

anova$sterilise <- anova(anova$sterilise) 

knitr::kable(anova$sterilise, digits = 3,
             caption = "(ref:sterilised-anova)")
```

Figure \@ref(fig:PVE-sterilised) shows the variance explained by major terms, and an interaction plot of group means. It is configured to have the same layout as figure \@ref(fig:PVE-reinoculated).

```{r treatments-sterilised, include=FALSE}

sterilised <- list()

font_size= 0.7
par(mar = c(0,4,0,0))
plot(c(0,9), c(0,-3), type='n', axes=F, xlab = "", ylab="")
# Draw boxes under the plot
rect((1:8)-0.5, -0.5, (1:8)+0.5, -1, col = rep(c("#eb624c", "#1d3d90ff"), each=4))
rect((1:8)-0.5, -1,   (1:8)+0.5, -1.5,  col = rep(c("#eb624c", "#1d3d90ff"), each=2))
rect((1:8)-0.5, -1.5, (1:8)+0.5, -2, col = c('gray70',0))
rect((1:8)-0.5, -2,   (1:8)+0.5, -2.5, col = 0)
# Insert labels in the boxes
text(1:8, -0.75, rep(c("It", "Sw"), each= 4), cex=font_size)
text(1:8, -1.25, rep(c("It", "Sw"), each=4), cex=font_size)
text(1:8, -1.75, c("No", "Yes", "No", "Yes"), cex=font_size)
text(1:8, -2.25, c("-", "-", "-", "-"), cex=font_size)

text(0.4, -0.75, "Climate",    xpd=NA, adj = c(1,0.5), cex=font_size)
text(0.4, -1.25, "Soil",       xpd=NA, adj = c(1,0.5), cex=font_size)
text(0.4, -1.75, "Autoclaved", xpd=NA, adj = c(1,0.5), cex=font_size)
text(0.4, -2.25, "Inoculum",   xpd=NA, adj = c(1,0.5), cex=font_size)

sterilised$trt<- recordPlot()
```

(ref:sterilised) Plant fitness on sterilised vs unsterilised native soils. (A) Treatments presented. (B) variance in number of seeds per seedling planted explained in a model including climate chamber, plant genotype, recipient soil, whether soils were sterilised or not, and all two-, three- and four-way interactions. Non-significant terms are grouped as 'other terms'. (C) Interaction plots showing plant fitness in each treatment.

```{r PVE-sterilised, fig.cap=, fig.width=8/2.54, fig.height=18/2.54, fig.cap="(ref:sterilised)"}
sterilised$pve <- data.frame(
    term = row.names(anova$sterilise),
    p    = anova$sterilise$`Pr(>F)`,
    mse  = anova$sterilise$`Mean Sq`
  ) %>% 
    group_by(Term = replace(term, p > 0.05, 'Other terms')) %>% 
    summarise(
      Variance = sum(mse)
    ) %>% 
    mutate(Variance = Variance / sum(Variance)) %>% 
    mutate(Term = fct_reorder(Term, desc(Variance))) %>% 
    ggplot(aes(x = Term, y= Variance*100)) +
    geom_col() +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
    scale_x_discrete(
      labels = c('Genotype x\nChamber', 'Chamber', "Sterilisation", "Other terms", "Soil",  "Sterilisation x\nSoil", "Genotype", "Chamber x\nGeno. x Soil")
    ) +
    labs(
      y = "% variance explained"
    )
  
sterilised$interaction <- gnoto %>% 
    filter(Soil %in% c("Italy", "Sweden"), Tea == "No") %>% 
    group_by(Climate, Soil, Tea, geno, Sterile) %>% 
    summarise(
      mean = mean(fruits_per_seedling)
    ) %>% 
    mutate(
      Soil = ifelse(Soil == "Italy", "Italian", "Swedish"),
      Genotype = ifelse(geno == "It", "Italian", "Swedish"),
      Sterilised = ifelse( Sterile == 1, "Sterilised", "Not sterilised")
    ) %>% 
    ggplot(aes(
      x = Climate, y = mean, colour = Genotype,
      shape = Soil, group= paste(Genotype, Soil),
    )) +
    geom_point(size = 3) + 
    geom_line() +
    facet_grid(~ Sterilised) +
    theme_bw() + 
    scale_colour_manual(values = c('red3', 'blue4')) +
    theme(
      legend.position = "bottom",
      legend.title = element_text(size=10),
      axis.title.x = element_blank()
    )+
    labs(
      x = "Climate chamber",
      y = "Fruits per seedling planted"
    )+
    guides(
      color=guide_legend(nrow=2, byrow=TRUE),
      shape=guide_legend(nrow=2, byrow=TRUE)
    )
  
ggarrange(
  sterilised$trt,
  sterilised$pve,
  sterilised$interaction,
  nrow=3, labels = "AUTO", heights = c(1,3,3))
```
