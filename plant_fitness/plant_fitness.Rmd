---
title: "Plant fitness"
author: ""
date: "21st December/2021"
output:
  bookdown:::word_document2:
  bookdown::pdf_book:
    toc: no
    keep_tex: no
    number_sections: false


---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE, warning = FALSE, message = FALSE,
  fig.width=16.9/2.54, fig.height  = 20/2.54,
  cache = FALSE, cache.lazy = FALSE)

library(tidyverse)
library(lmerTest)
library(ggpubr)
library(cowplot)
library(gridGraphics)
```

```{r import-data}
# source('plant_fitness/utils.R')

gnoto <- read_csv(
  "plant_fitness/gnotobiotic_expt_fitness_data.csv",
  col_types = 'ffffffffdi'
)

field <- read_csv(
  "plant_fitness/field_expt_fitness_data.csv", col_types = 'ffffffi'
)

anova <- list()
```

# Reinoculated soils

Table \@ref(tab:anova-reinoculated) shows ANOVA results for plant fitness as a function of climate, plant genotype, soil matrix, soil wash, all two-, three- and the four-way interaction, and a random effect accounting for tub. Results are summarised in figure \@ref(fig:PVE-reinoculated).

(ref:anova) Analysis of variance in plant fitness on reinoculated soils. Plant fitness is the block-mean of each genotype, and modelled as a function of climate chamber, plant genotype, recipient soil and microbial inoculum, plus all two-, three- and four-way interactions. Block is included as a random effect.

```{r anova-reinoculated}
anova$reinoculated <- gnoto %>%
  filter(Soil %in% c("Italy", "Sweden"), Tea %in% c("Italy", "Sweden"), Sterile == 1) %>%
  lmer(formula = fruits_per_seedling ~ Climate * geno * Soil * Tea + plants_per_block + (1 | tub)) %>% 
  anova %>% 
  mutate(`Var. explained` = `Sum Sq` / sum(`Sum Sq`))
  

knitr::kable(anova$reinoculated, digits = 3,
             caption = "(ref:anova)")


```

(ref:reinoculated) Plant fitness on reinoculated soils. (A) Illustration of the treatments being compared. (B) variance in number of seeds per seedling planted explained in a model including climate chamber, plant genotype, recipient soil, microbial inoculum, and all two-, three- and four-way interactions. Non-significant terms are grouped as 'other terms'. (C) Interaction plots showing plant fitness in each treatment.

```{r treatments-reinoculated, include=FALSE}

reinoculated <- list()

font_size= 0.7
par(mar = c(0,4,0,0))
plot(c(0,9), c(0,-3), type='n', axes=F, xlab = "", ylab="")
# Draw boxes under the plot
rect((1:8)-0.5, -0.5, (1:8)+0.5, -1, col = rep(c("#eb624c", "#1d3d90ff"), each=4))
rect((1:8)-0.5, -1,   (1:8)+0.5, -1.5,  col = rep(c("#eb624c", "#1d3d90ff"), each=2))
rect((1:8)-0.5, -1.5, (1:8)+0.5, -2, col = 0)
rect((1:8)-0.5, -2,   (1:8)+0.5, -2.5, col = c("#eb624c", "#1d3d90ff", "#eb624c", "#1d3d90ff"))
# Insert labels in the boxes
text(1:8, -0.75, rep(c("It", "Sw"), each= 4), cex=font_size)
text(1:8, -1.25, rep(c("It", "Sw"), each=2), cex=font_size)
text(1:8, -1.75, c("Yes", "Yes", "Yes", "Yes"), cex=font_size)
text(1:8, -2.25, c("It", "Sw", "It", "Sw"), cex=font_size)

text(0.4, -0.75, "Chamber",   xpd=NA, adj = c(1,0.5), cex=font_size)
text(0.4, -1.25, "Soil",      xpd=NA, adj = c(1,0.5), cex=font_size)
text(0.4, -1.75, "Sterilised",xpd=NA, adj = c(1,0.5), cex=font_size)
text(0.4, -2.25, "Inoculum",      xpd=NA, adj = c(1,0.5), cex=font_size)

reinoculated$trt<- recordPlot()
```

```{r PVE-reinoculated, fig.cap="(ref:reinoculated)", fig.width=8/2.54, fig.height=18/2.54}
reinoculated$pve <-data.frame(
  term = row.names(anova$reinoculated),
  p    = anova$reinoculated$`Pr(>F)`,
  mse  = anova$reinoculated$`Mean Sq`
) %>% 
  group_by(Term = replace(term, p > 0.05, 'Other terms')) %>% 
  summarise(
    Variance = sum(mse)
  ) %>% 
  mutate(Term = fct_relevel(
    Term,
    "Climate", "geno", "Soil", "Climate:geno", "Climate:geno:Soil"
  )) %>% 
  arrange(Term) %>% 
  mutate(Variance = Variance / sum(Variance)) %>% 
  
  ggplot(aes(x = Term, y= Variance*100)) +
  geom_col() +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    axis.title.x=element_blank()) +
  scale_x_discrete(
    labels =
      c('Chamber', 'Genotype', 'Soil','Chamber x\nGenotype', "Chamber x\nGeno. x Soil",  "Other terms")
  ) +
  labs(
    y = "% var. explained"
  )


reinoculated$interaction <- gnoto %>% 
  filter(Soil %in% c("Italy", "Sweden"), Tea %in% c("Italy", "Sweden"), Sterile == 1) %>% 
  group_by(Climate, Soil, Tea, geno, Sterile) %>% 
  summarise(
    mean = mean(fruits_per_seedling)
  ) %>% 
  mutate(
    Soil = ifelse(Soil == "Italy", "Italian soil", "Swedish soil"),
    Genotype = ifelse(geno == "It", "Italian", "Swedish"),
    Inoculum = ifelse( Tea == "Italy", "Italian", "Swedish")
  ) %>% 
  ggplot(aes(
    x = Climate, y = mean, colour = Genotype,
    shape = Inoculum, group= paste(Genotype, Inoculum),
  )) +
  geom_point(size = 3) + 
  geom_line() +
  facet_grid(~ Soil) +
  theme_bw() + 
  scale_colour_manual(values = c('#eb624c', '#1d3d90ff')) +
  theme(
    legend.position = "bottom",
    legend.title = element_text(size=8),
    legend.text = element_text(size=8)
  )+
  labs(
    x = "Climate chamber",
    y = "Fruits per seedling planted"
  )+
  guides(
    color=guide_legend(
      nrow=2,
      byrow=TRUE,
      override.aes = list(linetype = 0, shape = 15)),
    shape=guide_legend(nrow=2, byrow=TRUE)
    # color = guide_legend()
  )

# cowplot::plot_grid(p0, p1, p2, rel_heights = c(1,2,2), nrow=3)
ggarrange(
  reinoculated$trt,
  reinoculated$pve,
  reinoculated$interaction,
  nrow=3, labels = "AUTO", heights = c(1,2,3))
```

# Field vs climate-chamber experiments

Tables \@ref(tab:anova-native) and \@ref(tab:anova-field) show full ANOVA tables for fitness in the chamber and field experiment. Figure \@ref(fig:field-vs-native) shows variance explained by each term, plus iteraction plots.

(ref:native) Analysis of variance in plant fitness on native, non-autoclaved soils. Plant fitness is the block-mean of each genotype, and modelled as a function of climate chamber, plant genotype, and recipient soil, plus all two- and three--way interactions. Block is included as a random effect.

```{r trt-native, include=FALSE}
field_native <- list()

font_size= 0.7
par(mar = c(0,4,0,0))
plot(c(0,5), c(0,-3), type='n', axes=F, xlab = "", ylab="")
# Draw boxes under the plot
rect((1:4)-0.5, -0.5, (1:4)+0.5, -1, col = rep(c("#eb624c", "#1d3d90ff"), each=2))
rect((1:4)-0.5, -1,   (1:4)+0.5, -1.5,  col = rep(c("#eb624c", "#1d3d90ff"), each=1))
rect((1:4)-0.5, -1.5, (1:4)+0.5, -2, col = 'gray70')
rect((1:4)-0.5, -2,   (1:4)+0.5, -2.5, col = 0)
# Insert labels in the boxes
text(1:4, -0.75, rep(c("It", "Sw"), each= 2), cex=font_size)
text(1:4, -1.25, rep(c("It", "Sw"), each=1), cex=font_size)
text(1:4, -1.75, "No", cex=font_size)
text(1:4, -2.25, "-", cex=font_size)

text(0.4, -0.75, "Chamber",   xpd=NA, adj = c(1,0.5), cex=font_size)
text(0.4, -1.25, "Soil",      xpd=NA, adj = c(1,0.5), cex=font_size)
text(0.4, -1.75, "Sterilised",xpd=NA, adj = c(1,0.5), cex=font_size)
text(0.4, -2.25, "Inoculum",      xpd=NA, adj = c(1,0.5), cex=font_size)

field_native$trt_native<- recordPlot()
```

```{r trt-field, include = F}
font_size= 0.7
par(mar = c(0,4,0,0))
plot(c(0,5), c(0,-3), type='n', axes=F, xlab = "", ylab="")
# Draw boxes under the plot
rect((1:4)-0.5, -0.5, (1:4)+0.5, -1, col = rep(c("#eb624c", "#1d3d90ff"), each=2))
rect((1:4)-0.5, -1,   (1:4)+0.5, -1.5,  col = rep(c("#eb624c", "#1d3d90ff"), each=1))
rect((1:4)-0.5, -1.5, (1:4)+0.5, -2, col = 'gray70')
rect((1:4)-0.5, -2,   (1:4)+0.5, -2.5, col = 0)
# Insert labels in the boxes
text(1:4, -0.75, rep(c("It", "Sw"), each= 2), cex=font_size)
text(1:4, -1.25, rep(c("It", "Sw"), each=1), cex=font_size)
text(1:4, -1.75, "No", cex=font_size)
text(1:4, -2.25, "-", cex=font_size)

text(0.4, -0.75, "Location",   xpd=NA, adj = c(1,0.5), cex=font_size)
text(0.4, -1.25, "Soil",      xpd=NA, adj = c(1,0.5), cex=font_size)
text(0.4, -1.75, "Sterilised",xpd=NA, adj = c(1,0.5), cex=font_size)
text(0.4, -2.25, "Inoculum",      xpd=NA, adj = c(1,0.5), cex=font_size)

field_native$trt_field<- recordPlot()
```


```{r anova-native}
anova$native <- gnoto %>%
  filter(Soil %in% c("Italy", "Sweden"), Sterile == 0) %>% 
  lmer(formula = fruits_per_seedling ~ Climate * geno * Soil + plants_per_block + (1 | tub)) %>% 
  anova() %>% 
  mutate(`Var. explained` = `Sum Sq` / sum(`Sum Sq`))

anova$native %>% 
  knitr::kable(
    digits = 3,
    caption = "(ref:native)"
  )
```

(ref:field) Analysis of variance of plant fitness on native, non-autoclaved soils in the chamber experiment, and the field experiment presented by Thiergart *et al.* (2020). Block-mean fitness of each genotype is modelled as a function of experimental site, plant genotype, and recipient soil, plus all two- and three-way interactions. Block is included as a random effect.

```{r anova-field}
# Calculate block-mean fitness for each genotype
anova$field <- field %>% 
  mutate(Block = paste(Site, Block, sep="_")) %>% 
  group_by(Block, Site, Soil, Genotype) %>% 
  summarise(
    fruits_per_seedling = mean(fruits_per_seedling)
  ) %>% 
  lmer(formula = fruits_per_seedling ~ Site * Genotype * Soil + (1|Block), data = .) %>% 
  anova() %>% 
  mutate(`Var. explained` = `Sum Sq` / sum(`Sum Sq`))


# anova$field <- lmer(formula = fruits_per_seedling ~ Site * Genotype * Soil + (1|Tray), data = field) %>% 
#   anova() %>% 
#   mutate(`Var. explained` = `Sum Sq` / sum(`Sum Sq`))

knitr::kable(
  anova$field,
  digits = 3,
  caption = "(ref:field)"
)

```

```{r field-vs-native, fig.cap="Plant fitness on native, non-autoclaved soils in the chamber experiment (A, C, E), and the field experiment presented by Thiergart *et al.* (2020) (B, D, F).  (A, B) Illustration of the treatments being compared. (C, D) variance in number of seeds per seedling planted explained in a model including climate chamber, plant genotype, recipient soil, whether soils were sterilised or not, and all two-, three- and four-way interactions. Non-significant terms are grouped as 'other terms'. (E, F) Interaction plots showing plant fitness in each treatment level showing Italian (red) and Swedish (blue) genotypes grown on Italian (circles) and Swedish (triangles) soils."}

field_native$pve_native <- data.frame(
  Term = row.names(anova$native),
  p    = anova$native$`Pr(>F)`,
  mse  = anova$native$`Mean Sq`
) %>% 
  mutate(Variance = mse / sum(mse)) %>% 
  mutate(Term = fct_relevel(
    Term,
    "Climate", "geno", "Soil", "Climate:geno", "Climate:Soil", "geno:Soil", "Climate:geno:Soil"
  )) %>% 
  arrange(Term) %>% 
  filter(Term != "plants_per_block") %>% 
  ggplot(aes(x = Term, y= Variance*100)) +
  geom_col() +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    axis.title.x=element_blank()) +
  scale_x_discrete(
    labels = c('Chamber', "Genotype", "Soil", 'Chamber x\nGenotype', "Chamber\nx Soil", "Genotype\nx Soil", "Chamber x\nGeno. x Soil")
  ) +
  labs(
    y = "% var. explained"
  ) +
  lims(
    y = c(0,60)
  )

field_native$pve_field <- data.frame(
  Term = row.names(anova$field),
  p    = anova$field$`Pr(>F)`,
  mse  = anova$field$`Mean Sq`
) %>% 
  mutate(Variance = mse / sum(mse)) %>% 
  mutate(Term = fct_relevel(
    Term,
    "Site", "Genotype", "Soil", "Site:Genotype", "Site:Soil", "Genotype:Soil", "Site:Genotype:Soil"
  )) %>% 
  arrange(Term) %>% 
  ggplot(aes(x = Term, y= Variance*100)) +
  geom_col() +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    axis.title.x=element_blank()) +
  scale_x_discrete(
    labels = c('Location','Genotype', "Soil", 'Location x\nGenotype', "Location\nx Soil", "Genotype\nx Soil", "Location x\nGeno. x Soil")
  ) +
  labs(
    y = "% var. explained"
  ) +
  lims(
    y = c(0,60)
  )


field_native$int_native <- gnoto %>% 
  filter(Soil %in% c("Italy", "Sweden"), Sterile == 0) %>% 
  group_by(Climate, Soil, geno) %>% 
  summarise(
    mean = mean(fruits_per_seedling)
  ) %>% 
  mutate(
    Soil = ifelse(Soil == "Italy", "Italian soil", "Swedish soil"),
    Genotype = ifelse(geno == "It", "Italian", "Swedish")
  ) %>% 
  ggplot(aes(
    x = Climate, y = mean, colour = Genotype,
    shape = Soil, group= paste(Genotype, Soil),
  )) +
  geom_point(size = 3) + 
  geom_line() +
  theme_bw() + 
  scale_colour_manual(values = c('#eb624c', '#1d3d90ff')) +
  labs(
    x = "Climate chamber",
    y = "Fruits per seedling planted"
  ) + 
  theme(legend.position="none")
# guides(
#   colour = guide_legend(override.aes = list(linetype = 0, shape = 15))
# )

field_native$int_field <- field %>% 
  group_by(Site, Soil, Genotype) %>% 
  summarise(
    mean = mean(fruits_per_seedling, na.rm=TRUE)
  ) %>% 
  mutate(
    Soil = ifelse(Soil == "It", "Italian soil", "Swedish soil"),
    Genotype = ifelse(Genotype == "Italy", "Italian", "Swedish")
  ) %>% 
  ggplot(aes(
    x = Site, y = mean, colour = Genotype,
    shape = Soil, group= paste(Genotype, Soil),
  )) +
  geom_point(size = 3) + 
  geom_line() +
  theme_bw() + 
  scale_colour_manual(values = c('#eb624c', '#1d3d90ff')) +
  labs(
    x = "Location",
    y = "Fruits per seedling planted"
  ) +
  theme(legend.position="none")
# guides(
#   colour = guide_legend(override.aes = list(linetype = 0, shape = 15))
# )

ggarrange(
  field_native$trt_native,
  field_native$trt_field,
  field_native$pve_native,
  field_native$pve_field,
  field_native$int_native,
  field_native$int_field,
  ncol=2, nrow=3,
  # common.legend = TRUE, 
  # legend = "none",
  labels = "AUTO",
  heights = c(1,2,3)
) +
  guides(
    colour = guide_legend(override.aes = list(linetype = 0, shape = 15))
  )

```

# Native vs sterilised vs repopulated soils

Table \@ref(tab:anova-nsr) and figure \@ref(fig:nsr-plot) show plant fitness on native (untreated), sterilised, and sterilised-and-reinoculated soils. 

(ref:anova-nsr) Analysis of variance in plant fitness on native (untreated), sterilised, and sterilised-and-reinoculated soils. Plant fitness is the block-mean of each genotype, and modelled as a function of climate chamber, plant genotype, recipient soil, sterilisation-reinoculation treatment, plus all two-, three- and four-way interactions. Block is included as a random effect, and the number of plants in each black as an additional fixed effect.

```{r anova-nsr}
anova$sterilise <- 
  gnoto %>%
  filter(! trt %in% c(4,7, 15, 19)) %>% 
  mutate(
    Treatment = ifelse(Sterile == 0, "Native", "Sterile"),
    Treatment = ifelse(Tea != "No", "Reinoculated", Treatment),
    Treatment = fct_relevel(Treatment, "Sterile", after = 2)
  ) %>%  
  lmer(formula = fruits_per_seedling ~ Climate * geno * Soil * Treatment + plants_per_block + (1 | tub)) %>% 
  anova %>% 
  mutate(`Var. explained` = `Sum Sq` / sum(`Sum Sq`))

knitr::kable(anova$sterilise, digits = 3,
             caption = "(ref:anova-nsr)")
```

```{r nsr-treatments, include=FALSE}

sterilised <- list()

font_size= 0.7
par(mar = c(0,4,0,0))
plot(c(0,13), c(1,-4), type='n', axes=F, xlab = "", ylab="")
# Draw boxes under the plot
rect((1:12)-0.5, -0.5, (1:12)+0.5, -1, col = rep(c("#eb624c", "#1d3d90ff"), each=6))
rect((1:12)-0.5, -1,   (1:12)+0.5, -1.5,  col = rep(c("#eb624c", "#1d3d90ff"), each=3))
rect((1:12)-0.5, -1.5, (1:12)+0.5, -2, col = c('gray70',0,0))
rect((1:12)-0.5, -2,   (1:12)+0.5, -2.5, 
     col = c(0, 0, "#eb624c", 0, 0, "#1d3d90ff")
     )
# Insert labels in the boxes
text(1:12, -0.75, rep(c("It", "Sw"), each= 6), cex=font_size)
text(1:12, -1.25, rep(c("It", "Sw"), each=3), cex=font_size)
text(1:12, -1.75, c("No", "Yes", "Yes"), cex=font_size)
text(1:12, -2.25, c("-", "-", "It", "-", "-", "Sw"), cex=font_size)

text(0.4, -0.75, "Chamber",    xpd=NA, adj = c(1,0.5), cex=font_size)
text(0.4, -1.25, "Soil",       xpd=NA, adj = c(1,0.5), cex=font_size)
text(0.4, -1.75, "Sterilised", xpd=NA, adj = c(1,0.5), cex=font_size)
text(0.4, -2.25, "Inoculum",   xpd=NA, adj = c(1,0.5), cex=font_size)

sterilised$trt<- recordPlot()
```

```{r nsr-means}
sterilised$means <- gnoto %>% 
  filter(! trt %in% c(4,7, 15, 19)) %>% 
  group_by(Climate, Soil, Sterile, Tea, geno) %>% 
  summarise(
    mean = mean(fruits_per_seedling)
  ) %>% 
  mutate(
    Soil = ifelse(Soil == "Italy", "Italian soil", "Swedish soil"),
    Genotype = ifelse(geno == "It", "Italian", "Swedish"),
    Treatment = ifelse(Sterile == 0, "Native", "Sterile"),
    Treatment = ifelse(Tea != "No", "Reinoculated", Treatment),
    Treatment = fct_relevel(Treatment, "Sterile", after = 2)
  ) %>% 
  rename(Chamber = Climate) %>%
  ggplot(aes(
    x = Treatment, y = mean,
    colour = Genotype, shape = Chamber, group = paste(Genotype, Chamber))) +
  geom_point(size=3) +
  geom_line() +
  facet_grid(~ Soil) +
  theme_bw() +
  scale_colour_manual(values = c('#eb624c', '#1d3d90ff')) +
  labs(
    y = "Fruits per seedling planted"
  )+
  theme(
    legend.position = "none"
    # axis.text.x = element_text(angle = 45, hjust = 1),
    # legend.title = element_text(size=8),
    # legend.text = element_text(size=8)
)
  # guides(
  #   colour = guide_legend(
  #     nrow=2, byrow=TRUE, override.aes = list(linetype = 0, shape = 15)
  #     ),
  #   # color=guide_legend(),
  #   shape=guide_legend(nrow=2, byrow=TRUE)
  # )

```


```{r nsr-interactions}

sterilised$interactions <- gnoto %>% 
  filter(! trt %in% c(4,7, 15, 19)) %>% 
  group_by(Climate, Soil, Sterile, Tea, geno) %>% 
  summarise(
    mean = mean(fruits_per_seedling)
  ) %>% 
  mutate(
    Soil = ifelse(Soil == "Italy", "Italian soil", "Swedish soil"),
    Genotype = ifelse(geno == "It", "Italian", "Swedish"),
    Treatment = ifelse(Sterile == 0, "Native", "Sterile"),
    Treatment = ifelse(Tea != "No", "Reinoculated", Treatment),
    Treatment = fct_relevel(Treatment, "Sterile", after = 2)
  ) %>% 
  rename(Chamber = Climate) %>%

  ggplot(aes(
    x = Chamber, y = mean,
    shape = Soil, colour = Genotype, group = paste(Genotype, Soil) 
    ))+
  geom_point(size=3) +
  geom_line() +
  facet_grid( Soil ~ Treatment) +
theme_bw() +
  scale_colour_manual(values = c('#eb624c', '#1d3d90ff')) +
  labs(
    y = "Fruits per seedling planted"
  )+
  theme(
    legend.position = "top",
    # axis.text.x = element_text(angle = 45, hjust = 1),
    # legend.title = element_text(size=8),
    # legend.text = element_text(size=8)
) +
  guides(
    colour = guide_legend(
      # nrow=2, byrow=TRUE, 
      override.aes = list(linetype = 0, shape = 15)
      ),
    # shape=guide_legend(nrow=2, byrow=TRUE)
  )
```

(ref:nsr-plot) Plant fitness on native (untreated), sterilised, and sterilised-and-reinoculated soils. (A) Illustration of the treatments being compared. (B) Changes in genotype-treatment means in each soil treatment. (C) Interaction plots illustrating the changes in the chamber x genotype interaction in each soil treatment.

```{r nsr-plot, fig.width=18/2.54, fig.height=20/2.54, fig.cap= "(ref:nsr-plot)"}
top_row <- ggarrange(sterilised$trt, sterilised$means, labels = c("A", "B"), heights = c(1,2))

ggarrange(top_row, sterilised$interactions, nrow=2, labels = c("-", "C"), heights = c(3,5))
```

